<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">

<body>

<!-- content -->
<th:block th:replace="~{./include/baselayout :: setContent( ~{ :: .bon-wrap } )}">
    <div class="bon-wrap">
        <div class="page-title">
            <p>숙제</p>
        </div>
        <div class="route-wrap">
            <a href="#">숙제</a><p>/</p><a href="#">내 숙제리스트</a><p>/</p><a href="#">[[${vo.homework_title}]]</a>
        </div>
        <div class="bon-content-wrap">
            <div class="two-m">
                <div class="content-box fl-row-m">
                    <h3 style="margin-bottom: 10px;">[[${vo.homework_title}]]</h3>

                    <div class="reg-title-wrap">
                        <div class="group-naming-wrap-m">
                            <div class="reg-title-wrap" style="margin-bottom: 15px;">
                                <div class="like-table-wrap">
                                    <div class="sinfo-wrap-m">
                                        <p>레벨</p>
                                        <h4 class="name-m">[[${vo.homework_level}]]</h4>
                                    </div>
                                    <div class="sinfo-wrap-m">
                                        <p>제한시간</p>
                                        <h4 class="name-m"><i class="ri-timer-line"></i>[[${vo.homework_time}]]초</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="group-name">
                                <label>숙제내용</label>

                                <p>[[${vo.homework_content}]]</p>
                            </div>
                            <div class="group-name">
                                <label>숙제힌트</label>

                                <p>[[${vo.homework_hint}]]</p>
                            </div>
                            <div class="group-name">
                                <label>입출력 예시</label>
                                <th:block th:each="i : ${vo2}">
                                <div class="inout-m ex-inp-m">
                                    <div class="h-ex-wrap flc-center-mm" style="margin-bottom: 0">
                                        <label>입력값</label>
                                        <label>결과값</label>
                                    </div>
                                    <div class="h-ex-wrap flc-center-mm" style="margin-bottom: 30px; text-align: center;">

                                            <label><div>[[${i.input}]]</div></label>
                                            <label><div>[[${i.output}]]</div></label>

                                    </div>
                                </div>
                                <label>설명</label>
                                <p>[[${i.ex_ct}]]</p>
                                </th:block>

                            </div>

                        </div>

                    </div>

                </div>

                <div class="content-box fl-row-m2" >
                    <h3 style="margin-bottom: 10px;">solution</h3>
                    <div class="reg-title-wrap">
                        <div class="code-editor">
                            <div class="line-numbers"></div>
                            <textarea id="code" onkeydown="handleTab(event)"></textarea>
                        </div>
                    </div>
                    <div class="reg-title-wrap"  >
                        <div class="result-m" style="display: none">

                            <th:block th:each="item, status: ${vo3}">
                                <div class="test-m" th:id="${status.index}" th:data-input="${item.test_input}" th:data-output="${item.test_output}">
                                    <h4>테스트[[${status.index + 1}]]</h4>
                                    <div class="loader" style="display: flex; align-items: center"></div>
                                </div>
                            </th:block>

                        </div>
                    </div>
                </div>

            </div>
            <div class="reg-btn-wrap">
                <button type="button" id="sub-btn">체점하기</button>
            </div>
        </div>
    </div>

</th:block>


<script>



    function handleTab(event) {
        // Tab 키 눌렀을 때
        if (event.keyCode === 9) {
            // 탭의 위치
            var start = event.target.selectionStart;
            var end = event.target.selectionEnd;

            // 탭 앞뒤로 스페이스 4개 추가
            var value = event.target.value;
            event.target.value = value.substring(0, start) + "    " + value.substring(end);

            // 커서 위치 조정
            event.target.selectionStart = event.target.selectionEnd = start + 4;

            // 기본 이벤트 방지
            event.preventDefault();
        }
    }

    $.fn.checkCode = function(code, input, answer, num, callback) {
        var element = this; // 현재 요소를 가리키는 jQuery 객체를 저장합니다.

        element.find('.loader').show();
        $.ajax({
            url: "/checkCode",
            type: "POST",
            contentType: "application/json",
            dataType: "text",
            data: JSON.stringify({ code: code, input: input, answer: answer }),
            success: function(data) {
                element.find('.loader').hide();
                console.log(data);

                if (data == "통과") {
                    element.append('<p class="st-mm"><i class="ri-checkbox-circle-line"></i>통과</p>');
                } else if (data == "실패") {
                    element.append('<p class="fail-m"><i class="ri-alert-line"></i>실패</p>');
                } else {
                    element.append('<p class="fail-m"><i class="ri-alert-line"></i>컴파일에러</p>');
                }

                // 콜백 함수 실행
                if (callback && typeof callback === "function") {
                    callback();
                }
            },
            error: function(error) {
                console.error("Error:", error);
            }
        });
    };


    $("#sub-btn").on("click", function (e) {
        $(".result-m").css("display", "flex");
        var code = $("#code").val();

        $(".st-mm, .fail-m").remove();

        runNextTest($(".test-m"), code, 0);
    });

    function runNextTest(tests, code, index) {
        if (index >= tests.length) {
            return; // 테스트가 더 이상 없으면 종료
        }

        var $currentTest = $(tests[index]);

        $currentTest.checkCode(code, $currentTest.attr("data-input"), $currentTest.attr("data-output"), index, function () {
            // 콜백이 돌아왔을 때 다음 테스트 실행
            runNextTest(tests, code, index + 1);
        });
    }




</script>
</body>
</html>